# Preview Deployments

Preview deployments are useful when you'd like to share your application with others on the internet. If you deploy to an embedded environment where Gimlet runs, you'll receive an `app.gimlet.io` URL which you can send to people you'd like to share your deployed application with.

It's ideal for deployments of non-mainline versions on demand.

You can also configure preview deployments for dedicated domains, which you can find out how in the [DNS documentation]().

## Previews in Gimlet's Dashboard

Here's how you can create preview deployments:

Navigate to `Previews` in the menu of your selected repository on top.

### General Settings

Check if the repository's commit history is listed below, then click the `Edit Preview Config` button.

If it's not turned on, make sure the `Preview Deploy` button is turned on in case it's not inactive.

Enter the environment's name if you don't use one generated by us, and the name of the application.

Select the deployment's template. You can learn more about templates and image configuration settings [here]()<--- this'll be Build with Gimlet docs.

Enter the namespace in case you'd like to use one. Learn about namespaces here [here]()<--- this'll be Kubernetes concepts docs.

### Build

Among build settings, specify the image's tag.

Build script contains the commands required to build the application, and assets should be a folder that contains the build's generated files.

It should look like this:

![](/src/pages/docs/screenshots/gimlet-documentation-build-settings.png)

### Ingress

This is where you can specify a custom domain in case you'd like to use a non-Gimlet link to share your application. You can also turn on HTTPS certification here.

You can learn more about Ingress in the [DNS documentation]().

## Manual Preview Configuration

### Preview Gimlet Environment

You can configure preview environments manually with Gimlet by using Gimlet's manifest file. It utilizes a declarative format to configure which Helm chart, what chart version, and what parameters should be deployed to an environment.

Run the `gimlet manifest template` as seen in the example below, and open the configuration page at the address in the output.

```
gimlet manifest configure -f .gimlet/preview-app.yaml

👩‍💻 Configure on http://127.0.0.1:24349
👩‍💻 Close the browser when you are done
```

Below you can see an example. You can add `preview: true` as seen below:

```
app: preview-app
env: charmed-flower
preview: true
namespace: default
chart:
  name: https://github.com/gimlet-io/onechart.git?branch=simplified-schema&path=/charts/onechart/
values:
  containerPort: 80
  image:
    registry: builtInRegistry
    repository: nginx
    strategy: static
    tag: 1.19.3
  replicas: 1
```

### Policies for preview app deploys

Now that the naming and templating is covered, using policy based releases, you can define policies that automatically deploy your Pull Requests or branches.

The following snippet deploys app pushes on branches that match the `feature/*` wildcard pattern. Variables are used to guarantee unique resource names, and avoid collision.

It also applies sanitization on the branch name, to fit Kubernetes resource name limitations, and DNS naming rules.

```
# .gimlet/preview-env.yaml
- app: myapp-{{ .BRANCH }}
+ app: myapp-{{ .BRANCH | sanitizeDNSName }}
env: staging
namespace: my-team
chart:
  repository: https://chart.onechart.dev
  name: onechart
  version: 0.32.0
+deploy:
+  branch: feature/*
+  event: push
values:
  replicas: 1
  image:
    repository: myapp
    tag: "{{ .GIT_SHA }}"
  ingress:
-    host: "myapp-{{ .BRANCH }}.staging.mycompany.com"
+    host: "myapp-{{ .BRANCH | sanitizeDNSName }}.staging.mycompany.com"
    tlsEnabled: true

```

The next example is using the `event: pr` trigger to deploy Pull Requests:

```
# .gimlet/preview-env.yaml
app: myapp-{{ .BRANCH | sanitizeDNSName }}
env: staging
namespace: my-team
chart:
  repository: https://chart.onechart.dev
  name: onechart
  version: 0.32.0
deploy:
-  branch: feature/*
-  event: push
  event: pr
values:
  replicas: 1
  image:
    repository: myapp
    tag: "{{ .GIT_SHA }}"
  ingress:
    host: "myapp-{{ .BRANCH | sanitizeDNSName }}.staging.mycompany.com"
    tlsEnabled: true

```

For all other possibilities, please refer to the [Gimlet manifest reference](https://gimlet.io/docs/gimlet-manifest-reference#policy-based-releases) page.

### Cleaning up preview apps

If you deploy preview apps with dynamic names, like with the branch name in the app name, you can use Gimlet's cleanup policies to clean them up once you don't need them anymore.

```
# .gimlet/preview.yaml
app: myapp-{{ .BRANCH | sanitizeDNSName }}
env: staging
namespace: staging
chart:
  repository: https://chart.onechart.dev
  name: onechart
  version: 0.28.0
deploy:
  branch: feature/*
  event: push
+cleanup:
+  branch: feature/*
+  event: branchDeleted
+  app: myapp-{{ .BRANCH | sanitizeDNSName }}
values:
  replicas: 1
  image:
    repository: ghcr.io/podtato-head/podtatoserver
    tag: "{{ .SHA }}"
  gitRepository: laszlocph/gimletd-test-repo
  gitSha: "{{ .SHA }}"
```

The above snippet has a cleanup section that is triggered

- on the `branchDeleted` event,
- if the branch that is deleted matches the `feature/*` pattern.

Once the policy triggers, it deletes applications that are matching the `myapp-{{ .BRANCH | sanitizeDNSName }}` pattern.

All three fields are mandatory.

Variables in cleanup policies

Please note that only the `{{ .BRANCH }}` variable is available for the `branchDeleted` event.

At the time of deletion the shipped artifacts and their extensive variable set is not available, only the branch name is known that got deleted.
